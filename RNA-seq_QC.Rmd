---
title: "RNA-seq_QC"
author: "Kate Randall"
date: "2025-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load pkgs

```{r}
library(tidyverse)
library(ggpubr)
library(jsonlite)
```



# Fastp summary

```{r}
setwd("~/Desktop/KR_RNA-seq")


# pull summary data from JSONs
fastp_files <- list.files("trimmed", pattern = "_fastp.json$", full.names = TRUE)

fastp_metrics <- map_dfr(fastp_files, function(f) {
  d <- fromJSON(f)
  tibble(
    sample = str_remove(basename(f), "_fastp.json"),
    total_reads_before = d$summary$before_filtering$total_reads,
    total_reads_after  = d$summary$after_filtering$total_reads,
    q30_rate_before    = d$summary$before_filtering$q30_rate,
    q30_rate_after     = d$summary$after_filtering$q30_rate,
    gc_before          = d$summary$before_filtering$gc_content,
    gc_after           = d$summary$after_filtering$gc_content,
    read1_mean_length_before = d$summary$before_filtering$read1_mean_length,
    read1_mean_length_after  = d$summary$after_filtering$read1_mean_length
  )
})

fastp_metrics



# plot- total reads before/after filtering
fastp_metrics %>%
  pivot_longer(
    cols = c(total_reads_before, total_reads_after),
    names_to = "stage",
    values_to = "total_reads"
  ) %>%
  mutate(stage = recode(stage,
                        "total_reads_before" = "Before Filtering",
                        "total_reads_after"  = "After Filtering")) %>%
  ggplot(aes(x = sample, y = total_reads / 1e6, fill = stage)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Total Reads (millions)", x = "Sample", fill = "Stage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# plot- Q30 rate before/after filtering
fastp_metrics %>%
  pivot_longer(
    cols = c(q30_rate_before, q30_rate_after),
    names_to = "stage",
    values_to = "q30_rate"
  ) %>%
  mutate(stage = recode(stage,
                        "q30_rate_before" = "Before Filtering",
                        "q30_rate_after"  = "After Filtering")) %>%
  ggplot(aes(x = sample, y = q30_rate, fill = stage)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Q30 Rate", x = "Sample", fill = "Stage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# plot- GC content before/after filtering
fastp_metrics%>%
  pivot_longer(
    cols = c(gc_before, gc_after),
    names_to = "stage",
    values_to = "gc_content"
  ) %>%
  mutate(stage = recode(stage,
                        "gc_before" = "Before Filtering",
                        "gc_after"  = "After Filtering")) %>%
  ggplot(aes(x = sample, y = gc_content, fill = stage)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "GC Content", x = "Sample", fill = "Stage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



# STAR alignment summary

```{r}
star_dir <- "aligned"
star_logs <- list.files(star_dir, pattern = "_Log.final.out$", full.names = TRUE)

parse_star_log <- function(file) {
  lines <- readLines(file)
  tibble(
    sample = str_replace(basename(file), "_Log.final.out", ""),
    uniquely_mapped = as.numeric(str_extract(lines[grep("Uniquely mapped reads %", lines)], "\\d+\\.\\d+")),
    multi_mapped = as.numeric(str_extract(lines[grep("% of reads mapped to multiple loci", lines)], "\\d+\\.\\d+")),
    unmapped = 100 - (uniquely_mapped + multi_mapped)
  )
}

star_summary <- bind_rows(lapply(star_logs, parse_star_log))

p_star <- star_summary %>%
  pivot_longer(cols = c(uniquely_mapped, multi_mapped, unmapped), names_to = "type", values_to = "percent") %>%
  ggplot(aes(x = sample, y = percent, fill = type)) +
  geom_bar(stat = "identity") +
  ylab("Percentage of reads") +
  ggtitle("STAR alignment summary") +
  theme_minimal()
p_star

```



#FeatureCounts summary

```{r}
counts_dir <- "counts"
count_files <- list.files(counts_dir, pattern = ".summary$", full.names = TRUE)

parse_summary <- function(file) {
  df <- read_tsv(file, col_names = c("category", "count"))
  assigned <- df$count[df$category == "Assigned"]
  tibble(
    sample = str_replace(basename(file), "_featureCounts.txt.summary", ""),
    assigned_reads = assigned
  )
}

counts_summary <- bind_rows(lapply(count_files, parse_summary)) %>%
  mutate(assigned_reads = as.numeric(assigned_reads))

p_counts <- ggplot(counts_summary, aes(x = sample, y = assigned_reads)) +
  geom_col(fill = "steelblue") +
  scale_y_continuous(labels=label_comma(), limits=c(0, NA)) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Assigned Reads per Sample (featureCounts)",
    x = "Sample",
    y = "Assigned Reads"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
p_counts

```


# Fractional multimappers (counts_fractional) vs original counts (multimappers discarded)

```{r}
# read the merged table
counts <- read_tsv("merged_counts.txt", col_types = cols())

#remove duplicate header
counts <- counts[-1, ]

counts<- as.data.frame(counts)

counts_long <- counts %>%
  pivot_longer(
    cols = -Geneid,
    names_to = "sample_type",
    values_to = "count")
  

counts_long <- counts_long %>%
    separate(sample_type, 
             into = c("sample", "replicate", "type"), 
             sep = "_",
             extra = "merge") %>%
    mutate(sample = paste(sample, replicate, sep = "_"),
           count = as.numeric(count)) %>%
    select(Geneid, sample, type, count)

head(counts_long)


# summarize total counts per sample and type
summary_counts <- counts_long %>%
  group_by(sample, type) %>%
  summarize(total = sum(count, na.rm = TRUE), .groups = "drop")

# make sure type is ordered for plotting
summary_counts$type <- factor(summary_counts$type, levels = c("raw", "frac"))

# bar plot: total assigned reads per sample
ggplot(summary_counts, aes(x = sample, y = total, fill = type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  labs(
    title = "Comparison of Raw vs Fractional FeatureCounts",
    x = "Sample",
    y = "Total Assigned Reads",
    fill = "Count Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )


```

